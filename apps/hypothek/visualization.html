<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
  <style>
    #vis {
      width: 80%;
    }
  </style>
</head>

<body>
  <div id="vis" />
  <script>
    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "description": "Plots a function using a generated sequence.",
      "width": "container",
      "height": 300,
      "data": {
        "sequence": { "start": 50000, "stop": 1000000, "step": 5000, "as": "price" }
      },
      "transform": [
        {
          "calculate": "if(pk/datum.price>=0.1, datum.price*0.1,(0.2-(pk/datum.price))*datum.price)",
          "as": "condition1"
        },
        {
          "calculate": "datum.price-pk-(ratio*income-0.01*datum.price)/0.06",
          "as": "condition_temp"
        },
        {
          "calculate": "if(datum.condition_temp>0, datum.condition_temp, 0)",
          "as": "condition2"
        },
        {
          "calculate": "max(datum.condition1, datum.condition2)",
          "as": "condition_both"
        },
        { "fold": ["condition1", "condition2", "condition_both"] }
      ],
      "mark": { "type": "line","tooltip": true},
      "params": [
        { "name": "pk", "value": 50000, "bind": { "input": "number", "name": "Pension" } },
        { "name": "income", "value": 100000, "bind": { "input": "number", "name": "Income" } },
        { "name": "ratio", "value": 0.33, "bind": { "input": "range", "name": "Equity ratio", "min": 0.30, "max": 0.40, "step": 0.01 } },
        {
          "name": "hover", "select": {
            "type": "point",
            "fields": ["price"],
            "nearest": true,
            "on": "mouseover",
            "clear": "mouseout"
          }
        }

      ],
      "encoding": {
        "x": { "field": "price", "type": "quantitative", "title": "Price" },
        "y": { "field": "value", "type": "quantitative", "title": "Cash needed" },
        "color": { "field": "key", "type": "nominal" },

      },
      "config": {}
    };
    vegaEmbed("#vis", spec, { mode: "vega-lite" }).then(console.log).catch(console.warn);
  </script>
</body>

</html>