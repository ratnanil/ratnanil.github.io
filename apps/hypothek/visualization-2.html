<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
    <style>
        #vis {
            width: 80%;
        }
    </style>
</head>

<body>
    <label for="maxprice">Maxprice:</label>
    <input type="number" id="maxprice" name="Max Price" min="100000" value="1000000" step="100000">
    <button  onclick="getInputValue();">Regenerate</button>
    <div id="vis" /> <br>

    <script>
        getInputValue();
        function getInputValue() {
            
            // Selecting the input element and get its value 
            let maxprice = document.getElementById("maxprice").value;
            console.log(maxprice)
            const spec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "description": "Plots a function using a generated sequence.",
                "width": "container",
                "height": 300,
                "data": {
                    "sequence": { "start": 50000, "stop": maxprice, "step": 10000, "as": "price" }
                },
                "transform": [
                    {
                        "calculate": "if(pk/datum.price>=0.1, datum.price*0.1,(0.2-(pk/datum.price))*datum.price)",
                        "as": "condition1"
                    },
                    {
                        "calculate": "datum.price-pk-(ratio*income-0.01*datum.price)/0.06",
                        "as": "condition_temp"
                    },
                    {
                        "calculate": "if(datum.condition_temp>0, datum.condition_temp, 0)",
                        "as": "condition2"
                    },
                    {
                        "calculate": "max(datum.condition1, datum.condition2)",
                        "as": "condition_both"
                    },
                ],
                "params": [
                    { "name": "pk", "value": 50000, "bind": { "input": "number", "name": "Pension", "step": 5000 } },
                    { "name": "income", "value": 100000, "bind": { "input": "number", "name": "Income", "step": 5000 } },
                    { "name": "ratio", "value": 0.33, "bind": { "input": "range", "name": "Equity ratio", "min": 0.30, "max": 0.40, "step": 0.01 } },
                ],
                "layer": [

                    {
                        "mark": { 
                            "type": "point", 
                            "fill": "red", 
                            "stroke": false, 
                            "tooltip": true
                        },
                        "encoding": {
                            "x": { "field": "price", "type": "quantitative", "title": "Price" },
                            "y": { "field": "condition_both", "type": "quantitative", "title": "Cash needed" },
                            "opacity": {
                                "condition": { "value": 1, "param": "hover", "empty": false },
                                "value": 0
                            },
                            "tooltip": [
                                {"field": "price", "type": "quantitative", "title": "Price"}, 
                                {"field": "condition_both", "type": "quantitative", "title": "Cash",}, 

                            ] 
                        },
                        "params": [{
                            "name": "hover",
                            "select": {
                                "type": "point",
                                "nearest": true,
                                "on": "mouseover",
                                "clear": "mouseout",
                                "encodings": ["x"] 
                            }
                        }]


                    },
                    {
                        "mark": "rule",
                        "encoding": {
                            "x": { "field": "price", "type": "quantitative" },
                            "opacity": {
                                "value": 0,
                                "condition": { "value": 0.3, "param": "hover", "empty": false }

                            },

                        },

                    },
                    {
                        "mark": { "type": "rule" },
                        "encoding": {
                            "y": { "field": "condition_both", "type": "quantitative" },
                            "opacity": {
                                "value": 0,
                                "condition": { "value": 0.3, "param": "hover", "empty": false }

                            },

                        },

                    },
                    {
                        "transform": [
                            {"fold": ["condition1", "condition2"]},
                            {"calculate": "{'condition1': 'Deckungsgrad', 'condition2': 'Tragbarkeit'}[datum.key]", "as": "key"}
                        ],
                        "mark": { "type": "line", "color": "orange"},
                        "encoding": {
                            "x": { "field": "price", "type": "quantitative" },
                            "y": { "field": "value", "type": "quantitative" },
                            "color": {"field": "key", "type": "nominal"}
                        },
                        

                    },
                   
                ],
                "config": {}
            };
            vegaEmbed("#vis", spec, { mode: "vega-lite" }).then(console.log).catch(console.warn);

        }
    </script>
</body>

</html>